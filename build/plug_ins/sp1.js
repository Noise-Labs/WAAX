!function(WX){"use strict";function SP1Voice(sampler){this.parent=sampler,this.params=sampler.params,this.voiceKey=null,this.minDur=null,this._src=WX.Source(),this._srcGain=WX.Gain(),this._src.to(this._srcGain).to(this.parent._filter),this._src.buffer=this.parent.buffer,this._src.onended=function(){this.parent.voiceEndedCallback(this.voiceKey)}.bind(this)}function SP1(preset){WX.PlugIn.defineType(this,"Generator"),this.ready=!1,this.voices={},this.buffer=null,this._filter=WX.Filter(),this._panner=WX.Panner(),this._filter.to(this._panner).to(this._output),WX.defineParams(this,{tune:{type:"Generic",name:"Tune","default":48,min:0,max:127,unit:"Semitone"},pitchMod:{type:"Boolean",name:"PitchMod","default":!0},velocityMod:{type:"Boolean",name:"VeloMod","default":!0},ampAttack:{type:"Generic",name:"Att","default":.02,min:0,max:5,unit:"Seconds"},ampDecay:{type:"Generic",name:"Dec","default":.04,min:0,max:5,unit:"Seconds"},ampSustain:{type:"Generic",name:"Sus","default":.25,min:0,max:1,unit:"LinearGain"},ampRelease:{type:"Generic",name:"Rel","default":.2,min:0,max:10,unit:"Seconds"},filterType:{type:"Itemized",name:"FiltType","default":"LP",model:WX.FILTER_TYPES},filterFrequency:{type:"Generic",name:"FiltFreq","default":2500,min:20,max:2e4,unit:"Hertz"},filterQ:{type:"Generic",name:"FiltQ","default":0,min:0,max:40},filterGain:{type:"Generic",name:"FiltGain","default":0,min:-40,max:40,unit:"LinearGain"},filterMod:{type:"Generic",name:"FiltMod","default":1,min:.25,max:8},filterAttack:{type:"Generic",name:"FiltAtt","default":.02,min:0,max:5,unit:"Seconds"},filterDecay:{type:"Generic",name:"FiltDec","default":.04,min:0,max:5,unit:"Seconds"},filterSustain:{type:"Generic",name:"FiltSus","default":.25,min:0,max:1,unit:"LinearGain"},filterRelease:{type:"Generic",name:"FiltRel","default":.2,min:0,max:10,unit:"Seconds"},pan:{type:"Generic",name:"Pan","default":0,min:-1,max:1}}),WX.PlugIn.initPreset(this,preset)}SP1Voice.prototype={noteOn:function(pitch,velocity,time){var p=this.params,basePitch=p.tune.get(),att=p.ampAttack.get(),dec=p.ampDecay.get(),sus=p.ampSustain.get(),scale=WX.veltoamp(velocity);console.log(att),this._src.playbackRate.value=Math.pow(2,(pitch-basePitch)/12),this._src.start(time),this._srcGain.gain.set(0,time,0),this._srcGain.gain.set(scale,time+att,1),this._srcGain.gain.set(sus*scale,[time+att,dec],3),this.minDur=time+att+dec},noteOff:function(pitch,velocity,time){if(this.minDur){time=time<WX.now?WX.now:time;var p=this.params,rel=p.ampRelease.get();this.voiceKey=pitch,this._src.stop(this.minDur+rel+1),time<this.minDur?(this._srcGain.gain.cancel(this.minDur),this._srcGain.gain.set(0,[this.minDur,rel],3)):this._srcGain.gain.set(0,[time,rel],3)}}},SP1.prototype={info:{name:"SP1",version:"0.0.1",api_version:"1.0.0-alpha",author:"Hongchan Choi",type:"Generator",description:"Versatile Single-Zone Sampler"},defaultPreset:{tune:60,pitchMod:!0,velocityMod:!0,ampAttack:.01,ampDecay:.44,ampSustain:.06,ampRelease:.06,filterType:"LP",filterFrequency:2500,filterQ:18,filterGain:0,filterMod:7,filterAttack:.01,filterDecay:.07,filterSustain:.07,filterRelease:.03,pan:0,output:.8},$filterType:function(value){this._filter.type=value},$filterFrequency:function(value,time,rampType){this._filter.frequency.set(value,time,rampType)},$filterQ:function(value,time,rampType){this._filter.Q.set(value,time,rampType)},$filterGain:function(value,time,rampType){this._filter.gain.set(value,time,rampType)},$filterDetune:function(value,time,rampType){this._filter.detune.set(value,time,rampType)},noteOn:function(pitch,velocity,time){time=time||WX.now;var voice=new SP1Voice(this);this.voices.hasOwnProperty(pitch)?this.voices[pitch].push(voice):this.voices[pitch]=[voice],voice.noteOn(pitch,velocity,time)},noteOff:function(pitch,velocity,time){if(this.voices.hasOwnProperty(pitch)){time=time||WX.now;for(var playing=this.voices[pitch],i=0;i<playing.length;i++)playing[i].noteOff(pitch,velocity,time)}},voiceEndedCallback:function(pitch){this.voices.hasOwnProperty(pitch)&&delete this.voices[pitch]},onData:function(action,data){switch(action){case"noteon":this.noteOn(data.pitch,data.velocity);break;case"noteoff":this.noteOff(data.pitch,data.velocity)}},_onprogress:function(){},_onloaded:function(clip){this.setClip(clip)},isReady:function(){return this.ready},setClip:function(clip){this.clip=clip,this.buffer=this.clip.buffer,this.ready=!0},loadClip:function(clip){WX.loadClip(clip,this._onloaded.bind(this),this._onprogress.bind(this))}},WX.PlugIn.extendPrototype(SP1,"Generator"),WX.PlugIn.register(SP1)}(WX);