var Timebase=function(WX){function a(a){return{beat:~~(a/f),tick:a%f}}function b(a){return a.beat*f+a.tick}function c(){this.pitch=60,this.velo=64,this.start=0,this.end=120,this.next=null}function d(){this.empty()}function e(a){this.BPM=a,this.oldBPM=a,this.absOrigin=0,this.absOldNow=0,this.now=0,this.loopStart=0,this.loopEnd=0,this.lookahead=0,this.BIS=0,this.TIS=0,this.playbackQ=[],this.notelists=[],this.views=[],this.RUNNING=!1,this.LOOP=!1,this.USE_METRONOME=!1,this.setBPM(a),this._loop()}var f=480;return c.prototype={get:function(){return{pitch:this.pitch,velo:this.velo,start:this.start,end:this.end}},getDuration:function(){return this.end-this.start},movePitch:function(a){this.pitch+=a,this.pitch=WX.clamp(this.pitch,0,127)},moveTime:function(a){var b=this.end-this.start;this.moveStart(a),this.end=this.start+b},moveStart:function(a){this.start+=a,this.start=WX.clamp(this.start,0,this.end-1)},moveEnd:function(a){this.end+=a,this.end=Math.max(this.end,this.start+1)},set:function(){WX.isObject(arguments[0])?(this.pitch=arguments[0].pitch,this.velo=arguments[0].velo,this.start=arguments[0].start,this.end=arguments[0].end):(this.pitch=arguments[0],this.velo=arguments[1],this.start=arguments[2],this.end=arguments[3])},valueOf:function(){return this.start},toString:function(){return this.pitch+":"+this.velo+":"+this.start+":"+this.end}},d.prototype={add:function(a){if(null===this.head)return this.head=a,this.playhead=this.head,void this.size++;if(a<=this.head)return a.next=this.head,this.head=a,void this.size++;for(var b=this.head;b;){if(a>b){if(!b.next){b.next=a;break}if(a<=b.next){a.next=b.next,b.next=a;break}}b=b.next}return void this.size++},empty:function(){this.head=null,this.playhead=null,this.size=0},findNoteAtPosition:function(a,b){for(var c=this.head;c;){if(c.pitch===a&&c.start<=b&&b<=c.end)return c;c=c.next}return null},findNotesInArea:function(a,b,c,d){for(var e=this.findNotesInTimeSpan(c,d),f=[],g=0;g<e.length;g++){var h=e[g].pitch;a>h||h>b||f.push(e[g])}return f},findNotesInTimeSpan:function(a,b){for(var c=this.head,d=[];c&&c.start<=b;)a<=c.start&&d.push(c),c=c.next;return d.length>0?d:0},getSize:function(){return this.size},getArray:function(){for(var a=this.head,b=[];a;)b.push(a),a=a.next;if(b.length>0){for(var c=0;c<b.length;c++)b[c].next=null;return b}return null},iterate:function(a){for(var b=this.head,c=0;b;)a(b,c++),b=b.next},remove:function(a){if(null!==this.head){var b;if(this.head===a)return b=this.head,this.head=this.head.next,b.next=null,this.size--,b;for(var c=this.head;c;){if(c.next===a)return b=c.next,c.next=c.next.next,b.next=null,this.size--,b;c=c.next}return null}},rewind:function(){this.playhead=this.head},setPlayheadAtTick:function(a){if(this.playhead=this.head,this.playhead)for(;this.playhead.start<a;)this.playhead=this.playhead.next},scan:function(a){if(this.playhead){for(var b=[];this.playhead.start<a;)b.push(this.playhead),this.playhead=this.playhead.next;return b.length>0?b:null}},dump:function(){for(var a=this.head,b=[];a;)b.push(a.toString()),a=a.next;return b}},e.prototype={tick2sec:function(a){return a*this.TIS},sec2tick:function(a){return a/this.TIS},getAbsTimeInSec:function(a){return this.absOrigin+this.tick2sec(a)},getBPM:function(){return this.BPM},getNowInSec:function(){return this.now},getNow:function(){return this.sec2tick(this.now)},getLoopDurationInSec:function(){return this.loopEnd-this.loopStart},getLoopDuration:function(){return this.sec2tick(this.getLoopDurationInSec())},setBPM:function(a){this.BPM=a;var b=this.oldBPM/this.BPM;this.oldBPM=this.BPM,this.BIS=60/this.BPM,this.TIS=this.BIS/f,this.lookahead=32*this.TIS,this.now*=b,this.loopStart*=b,this.loopEnd*=b,this.absOrigin=WX.now-this.now},setNowInSec:function(a){this.now=a,this.absOrigin=WX.now-this.now;for(var b=this.sec2tick(this.now),c=0;c<this.notelists.length;c++)this.notelists[c].setPlayheadAtTick(b)},setNow:function(a){this.setNowInSec(this.tick2sec(a))},setLoop:function(a,b){this.loopStart=this.tick2sec(a),this.loopEnd=this.tick2sec(b)},step:function(){if(this.RUNNING){var a=WX.now;this.now+=a-this.absOldNow,this.absOldNow=a,this.scanNotes(),this.flushPlaybackQ(),this.LOOP&&this.loopEnd-(this.now+this.lookahead)<0&&this.setNowInSec(this.loopStart-(this.loopEnd-this.now))}},scanNotes:function(){for(var a=0;a<this.notelists.length;a++){var b=this.sec2tick(this.now+this.lookahead),c=this.notelists[a].scan(b);c&&Array.prototype.push.apply(this.playbackQ,c)}},setScanPosition:function(a){for(var b=0;b<this.notelists.length;b++)this.notelists[b].setPlayheadAtTick(this.sec2tick(a))},_loop:function(){this.step(),this.updateView(),requestAnimationFrame(this._loop.bind(this))},isRunning:function(){return this.RUNNING},start:function(){this.playbackQ.length=0,this.setScanPosition(this.now);var a=WX.now;this.absOrigin=a-this.now,this.absOldNow=a,this.RUNNING=!0},pause:function(){this.RUNNING=!1},rewind:function(){this.setNowInSec(0)},addNoteList:function(a){this.notelists.push(a)},removeNoteList:function(){},flushPlaybackQ:function(){this.playbackQ.length=0},updateView:function(a){for(var b=0;b<this.views.length;b++)this.views[b].update(a[b])}},{Util:{tick2mbt:a,mbt2tick:b},createNote:function(){var a=new c;return a.set.apply(a,arguments),a},createNoteList:function(){return new d},Transport:new e(120)}}(WX);
//# sourceMappingURL=waax.map