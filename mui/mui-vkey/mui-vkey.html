<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../mui-button/mui-button.html">

<polymer-element name="mui-vkey" attributes="label">

<template>

  <style>
    :host {
      display: block;
      overflow: hidden;
    }
    .container {
    }
    .header {
      margin: 0 0 6px 0;
    }
    .header .button {
      padding: 2px;
      width: 28px;
      height: 28px;
      box-shadow: none;
      box-shadow: 0 0 0 1px #cfd8dc;
    }
    /*.header .button:hover {
      box-shadow: 0 1px 0 0 rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0, 0, 0, 0.1);
    }*/
    .c-oct-display {
      display: inline-block;
      vertical-align: middle;
      height: 28px;
      width: 48px;
      border-radius: 2px;
      color: #455a64;
      line-height: 28px;
      text-align: center;
      font-size: 11px;
      background-color: rgba(0, 0, 0, 0.1);
      box-shadow: inset 0 1px 0 0 rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0, 0, 0, 0.24);
    }
    .status-bar {
      float: right;
      display: inline-block;
      vertical-align: middle;
      height: 28px;
      width: 75px;
      margin: 0 1px;
      border-radius: 2px;
      color: #455a64;
      line-height: 28px;
      text-align: center;
      font-size: 11px;
      background-color: rgba(0, 0, 0, 0.1);
      box-shadow: inset 0 1px 0 0 rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0, 0, 0, 0.24);
    }
    .c-vkey {
      display: block;
      cursor: move;
      background-color: #cfd8dc;
      border-radius: 2px;
    }
    .c-wheel {
      stroke: #78909c;
      stroke-width: 2px;
      fill: #fff;
    }
    .c-wheel:hover {
      stroke: #546e7a;
    }
    .c-wheel-pos {
      fill: #78909c;
    }
    .c-wheel-box {
      fill: #78909c;
    }
    .c-white-key {
      fill: #fff;
    }
    .c-black-key {
      fill: #607d8b;
    }
    .active {
      fill: #039be5;
    }
  </style>

  <div class="container">
    <div class="header">
      <div id="eMsgPanel" class="status-bar">HELLO</div>
      <mui-button class="button" icon="hardware:keyboard" type="toggle" on-click="{{ toggleKeyboardInput }}" active="true"></mui-button>
      <mui-button class="button" icon="chevron-left" on-click="{{ octaveDown }}"></mui-button>
      <div class="c-oct-display">{{ _octaveStr }} oct.</div>
      <mui-button class="button" icon="chevron-right" on-click="{{ octaveUp }}"></mui-button>
    </div>
    <svg id="eTouchable" class="c-vkey" height="100" version="1.1" xmlns="http://www.w3.org/2000/svg">
      <rect class="c-wheel" x="6" y="6" width="32" height="88" rx="4" ry="4"></rect>
      <rect class="c-wheel" x="44" y="6" width="32" height="88" rx="4" ry="4"></rect>
      <rect id="ePitWhlPos" class="c-wheel-pos" x="7" y="50" width="30" height="1"></rect>
      <rect id="eModWhlPos" class="c-wheel-box" x="45" y="80" width="30" height="14" ry="2"></rect>
    </svg>
  </div>

</template>

<script>
  Polymer('mui-vkey', {

    // public parameter
    label: 'mui-vkey',
    octave: 0,
    captureKeyboard: true,

    // internal parameter
    _octaveOffset: 24,
    _octaveStr: '0',
    _numKeys: 60, // 5 octaves

    // key rendering parameters
    _svgWidth: 787,
    _offset: 72,
    _keyUpperY: 6,
    _keyLowerY: 52,
    _keyWidth: 18,
    _keyHeight: 42,
    _keyPaddingX: 2,
    _keyRadius: 2,

    // primary svg DOM object
    _svg: null,
    // internal key data strcuture
    _keys: [],
    // previous pitch (for mouse)
    _prevPitch: null,

    // keyCodeMap: zsxdcvgbhnjm q2w3er5t6y7u i
    _keyCodes: [
      90, 83, 88, 68, 67, 86, 71, 66, 72, 78, 74, 77,
      81, 50, 87, 51, 69, 82, 53, 84, 54, 89, 55, 85, 73
    ],

    // target plug-ins
    _targets: [],


    /**
     * Internal methods
     */

    // helper: 2d area detection
    _checkKeyArea: function (data) {
      if (data) {
        for (var i = 0; i < this._keys.length; i++) {
          var key = this._keys[i];
          // check y first
          if (key.y1 <= data.y && data.y <= key.y2) {
            // then check x
            if (key.x1 <= data.x && data.x <= key.x2) {
              return i;
            }
          }
        }
      }
      return null;
    },

    // helper: key render methods
    _renderKey: function (key) {
      var rect = document.createElementNS("http://www.w3.org/2000/svg", 'rect');
      rect.setAttribute('x', key.x1);
      rect.setAttribute('y', key.y1);
      rect.setAttribute('rx', this._keyRadius);
      rect.setAttribute('ry', this._keyRadius);
      rect.setAttribute('width', this._keyWidth);
      rect.setAttribute('height', this._keyHeight);
      rect.setAttribute('class', key.white ? 'c-white-key' : 'c-black-key');
      this._svg.appendChild(rect);
      return rect;
    },

    // building keyboard
    _buildKeys: function () {
      var i = 0, count = 0;
      while (count < this._numKeys) {
        var pclass = i % 14;
        i++;
        if (pclass === 5 || pclass === 13) continue;
        var white = (pclass % 2 === 0),
            x1 = this._offset + i * ((this._keyWidth + this._keyPaddingX) / 2),
            y1 = white ? this._keyLowerY : this._keyUpperY,
            x2 = x1 + this._keyWidth,
            y2 = y1 + this._keyHeight;
        var key = {
          white: white, state: false,
          x1: x1, y1: y1, x2: x2, y2: y2
        };
        key.rect = this._renderKey(key);
        this._keys[count] = key;
        count++;
      }
    },

    // highlight key
    _highlight: function (pitch) {
      if (pitch !== null) {
        var key = this._keys[pitch];
        key.rect.setAttribute('class', key.rect.getAttribute('class') + ' active');
      }
      if (this._prevPitch !== null) {
        key = this._keys[this._prevPitch];
        key.rect.setAttribute('class', key.rect.getAttribute('class').slice(0, 11));
      }
    },

    //
    _displayMessage: function (msg) {
      this.$.eMsgPanel.textContent = msg;
    },

    // action: { on, off, pitchwheel, modwheel }
    // data: on[pitch, velo] off[pitch,velo] pitchwheel[value], modwheel[value]
    _dispatch: function (sender, action, data) {
      // dispatch 'action' and 'data' to all connected destination
      for (var i = 0; i < this._targets.length; i++) {
        var plugin = this._targets[i].onData(action, data);
      }
    },


    /**
     * dispatch helpers
     */

    _start: function (pitch, velocity) {
      if (pitch !== null) {
        var xpitch = pitch + this._octaveOffset + this.octave * 12;
        this._dispatch(this.label, 'noteon', { pitch: xpitch, velocity: velocity });
        this._displayMessage('NOTE ON ' + xpitch);
        this._highlight(pitch);
        this._prevPitch = pitch;
      }
    },

    _glide: function (pitch) {
      if (pitch !== null && this._prevPitch !== pitch) {
        var xpitch = pitch + this._octaveOffset + this.octave * 12;
        this._dispatch(this.label, 'glide', { pitch: xpitch });
        this._displayMessage('GLIDE ' + xpitch);
        this._highlight(pitch);
        this._prevPitch = pitch;
      }
    },

    _stop: function (pitch) {
      var xpitch = pitch + this._octaveOffset + this.octave * 12;
      this._dispatch(this.label, 'noteoff', { pitch: xpitch, velocity: 0 });
      this._displayMessage('NOTE OFF');
      this._highlight(null);
      this._prevPitch = null;
    },

    _setPitchWheel: function (value) {
      this._dispatch(this.label, 'pitchwheel', { value: value });
      this._displayMessage('PWHEEL ' + value);
    },

    _setModWheel: function (value) {
      this._dispatch(this.label, 'modwheel', { value: value });
      this._displayMessage('MWHEEL ' + value);
    },

    /**
     * Key Event Hanlders
     */

    _listenKeyDown: function (event) {
      if (!this.captureKeyboard) return;
      var pitch = this._keyCodes.indexOf(event.keyCode);
      if (pitch > -1) {
        if (this._keys[pitch].state) return;
        this._keys[pitch].state = true;
        this._start(pitch + this._octaveOffset + this.octave * 12, 100);
      }
    },

    _listenKeyUp: function (event) {
      if (!this.captureKeyboard) return;
      var pitch = this._keyCodes.indexOf(event.keyCode);
      if (pitch > -1) {
        if (this._keys[pitch].state) {
          this._keys[pitch].state = false;
          this._stop(pitch + this._octaveOffset + this.octave * 12);
        }
      }
    },


    /**
     * Polymer-system methods
     */

    ready: function() {
      // set svg box size
      this._svg = this.$.eTouchable;
      this._svg.setAttribute('width', '100%');
      // build keys
      this._buildKeys();

      // hook mouse event listener
      var mouseResponder = MUI.MouseResponder(
        this.label,
        this._svg,
        function (sender, action, data) {
          var pitch = this._checkKeyArea(data);
          switch (action) {
            case 'clicked':
              this._start(pitch, 100);
              break;
            case 'dragged':
              this._glide(pitch);
              break;
            case 'released':
              this._stop(pitch);
              break;
          }
        }.bind(this)
      );

      // key listeners
      window.addEventListener('keydown', this._listenKeyDown.bind(this), false);
      window.addEventListener('keyup', this._listenKeyUp.bind(this), false);
    },

    // setTarget: function (oscnode, gainnode) {
    //   this.targetOsc = oscnode;
    //   this.targetGain = gainnode;
    //   this.targetOsc.frequency.set(WX.mtof(60), WX.now);
    //   this.targetGain.gain.set(0.0, WX.now);
    // },


    /**
     * DOM UI handlers
     */

    toggleKeyboardInput: function () {
      this.captureKeyboard = !this.captureKeyboard;
    },

    octaveUp: function () {
      this.octave++;
      this._octaveStr = (this.octave > 0 ? '+' : '') + this.octave.toString();
    },

    octaveDown: function () {
      this.octave--;
      this._octaveStr = (this.octave > 0 ? '+' : '') + this.octave.toString();
    },

    /**
     * Exports
     */

    addTarget: function (target) {
      this._targets.push(target);
    },

  });
</script>

</polymer-element>