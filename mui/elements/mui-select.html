<polymer-element name="mui-select" attributes="label key value">
  <!-- global style -->
  <link rel="stylesheet" polymer-scope="global" href="global.css">
  <template>
    <!-- style -->
    <style>
    @host {
      * {
        display: inline-block;
        width: 160px;
        height: 40px;
        margin: 8px 8px;
        vertical-align: top;
        -webkit-user-select: none;
      }
    }
    input:focus {
      outline: none;
    }
    .c-select-view {
      display: block;
      width: 158px;
      height: 20px;
      line-height: 20px;
      border-radius: 2px;
      border: 1px outset #ccc;
      background-color: #eee;
      cursor: pointer;
    }
    .c-select-view:active {
      background-color: #ddd;
      border: 1px inset #ccc;
      box-shadow: inset 0 5px 5px #ccc;
    }
    .c-select-value {
      width: 119px;
      height: 20px;
      padding: 0 4px;
      line-height: 20px;
      font-size: 12px;
      font-family:'Roboto', sans-serif;
      text-align: left;
    }
    .c-select-button {
      float: right;
      width: 20px;
      height: 20px;
      text-align: center;
      color: #31353D;
      border-left: 1px solid #aaa;
    }
    .c-select-label {
      display: block;
      width: 64px;
      height: 20px;
      line-height: 20px;
      font-family:'Play', sans-serif;
      font-size: 10px;
      text-align: left;
    }
    .c-select-dropdown {
      display: none;
      position: absolute;
      font-family:'Roboto', sans-serif;
      padding: 0;
      background-color: #ddd;
      border-radius: 0 0 3px 3px;
      border: 1px solid #aaa;
      vertical-align: top;
      z-index: 1000;
    }
    .c-select-dropdown ul {
      list-style: none;
      padding: 5px 0;
      margin: 0;
    }
    li.c-select-dropdown-item {
      height: 20px;
      line-height: 20px;
      font-size: 12px;
      margin: 2px 5px;
      text-align: left;
      width: 126px;
    }
    li.c-select-dropdown-item:hover {
      color: #fff;
      background-color: #445878;
    }
    </style>

    <!-- markup -->
    <div class="c-select-label">{{ label }}</div>
    <div id="eTouchable" class="c-select-view">
      <div class="c-select-button" on-click="menuClicked">&blacktriangledown;</div>
      <div class="c-select-value" on-click="menuClicked">{{ key }}</div>
      <div id="eDropdown" class="c-select-dropdown">
        <ul>
          <template id="eItems" class="c-select-dropdown" repeat>
            <li class="c-select-dropdown-item" on-click="itemClicked" id="{{ value }}">{{ key }}</li>
          </template>
        </ul>
      </div>
    </div>

  </template>

  <!-- logic -->
  <script>
  Polymer('mui-select', {

    // published
    label: 'unlabeled',
    key: 'not ready yet',
    value: null,

    // private
    menuShown: false,

    // binding
    targetUnit: null,
    targetParam: null,
    linked: false,

    render: function () {
      this.$.eDropdown.style.display = (this.menuShown) ? 'block' : 'none';
    },

    // model => knob
    update: function () {
      this.key = MUI.findKeyByValue(this.$.eItems.model, this.value);
      this.render();
    },

    // post: knob => model
    post: function () {
      this.value = MUI.findValueByKey(this.$.eItems.model, this.key);
      if (this.linked) {
        this.targetUnit.setParam(this.targetParam, this.value);
      }
      this.render();
    },

    menuClicked: function (event, detail, sender) {
      event.stopPropagation();
      this.menuShown = !this.menuShown;
      this.render();
    },

    itemClicked: function (event, detail, sender) {
      event.stopPropagation();
      this.key = sender.textContent;
      this.value = sender.id;
      this.menuShown = false;
      this.post();
    },

    attributeChanged: function (attrName, oldVal, newVal) {
      this.update();
    },

    ready: function () {
    },

    setModel: function (model) {
      this.$.eItems.model = model;
      this.post();
    },

    link: function (unit, paramName) {
      // setting reference to unit (ui => unitparam)
      this.targetUnit = unit;
      this.targetParam = paramName;
      this.linked = true;

      // handling parameter change in unit (unitparam => ui)
      // will invoke attributeChange when unitparam changed
      this.bind('value', unit.params, paramName);
    }
  });
  </script>

</polymer-element>