<!DOCTYPE html>
<html>
  <head>
    <link href="static/demos.css" rel="stylesheet" type="text/css">
    <link href="../lib/UI/UI-light.css" rel="stylesheet" type="text/css">
    <style>
      .c-clock {
        background-color: #333;
        width: 400px;
        height: 100px;
        border-radius: 10px;
        color: #3f3;
        font-size: 50px;
        font-family: monospace;
        line-height: 100px;
        text-align: center;
      }
    </style>
  </head>
  <body>

    <div class="c-demohome"><a href="index.html">Index</a></div>
    <h1>Metronome</h1>
    <div class="c-body-wrapper" id="i-container">
      <div class="c-clock" id="i-clock">000:00</div>
    </div>

    <!-- lib r8 -->
    <script src="../src/core/WAAX.js"></script>
    <script src="../src/core/Utils.js"></script>
    <script src="../src/core/Builtin.js"></script>
    <script src="../src/core/Unit.js"></script>
    <script src="../src/generator/Oscil.js"></script>
    <script src="../src/generator/Fmop.js"></script>
    <script src="../src/generator/Noise.js"></script>
    <script src="../src/generator/ITrain.js"></script>
    <script src="../src/generator/Sampler.js"></script>
    <script src="../src/generator/Step.js"></script>
    <script src="../src/processor/Fader.js"></script>
    <script src="../src/processor/Spatter.js"></script>
    <script src="../src/processor/ADSR.js"></script>
    <script src="../src/processor/Filter.js"></script>
    <script src="../src/processor/Filterbank.js"></script>
    <script src="../src/processor/Formant.js"></script>
    <script src="../src/processor/FormantV.js"></script>
    <script src="../src/processor/Pingpong.js"></script>
    <script src="../src/processor/Chorus.js"></script>
    <script src="../src/processor/Phasor.js"></script>
    <script src="../src/processor/Comp.js"></script>
    <script src="../src/processor/Converb.js"></script>
    <script src="../src/analyzer/Waveform.js"></script>
    <script src="../src/analyzer/Spectrum.js"></script>
    <script src="../src/core/Boot.js"></script>
    <!-- Ktrl -->
    <script src="../lib/Ktrl/Ktrl.js"></script>
    <script src="../lib/UI/UI.js"></script>
    <script src="../lib/UI/UISlider.js"></script>
    <script src="../lib/UI/UIButton.js"></script>
    <script src="../lib/UI/UIIndexedList.js"></script>
    <!-- scripts -->
    <script>

      // class
      function Event (beat, tick) {
        this.beat = beat;
        this.tick = tick;
      }

      Event.prototype = {
        set: function (beat, tick) {
          this.beat = beat;
          this.tick = tick;
        },
        move: function (dBeat, dTick) {
          this.beat += dBeat;
          if (dTick) {
            this.tick += dTick;
          }
        }
      };


      function Timeline (BPM) {
        // linear time (absolute)
        this.lOrigin = 0.0;
        this.lNow = 0.0;

        this.prevTimeStamp = 0.0;
        this.running = false;

        this.BPM = 120.0;
        this.BIS = 60.0 / this.BPM; // beat in seconds
        this.TIS = this.BIS / 480.0; // tick in seconds (1 beat = 480 tick)
      }

      Timeline.prototype = {
        getLinearTime: function (event) {
          return event.beat * this.BIS + event.tick * this.TIS;
        },

        getMusicalTime: function (time) {
          return {
            beat: ~~(time / this.BIS),
            tick: ~~((time % this.BIS) / this.TIS)
          };
        },

        setBPM: function (BPM) {
          var factor = this.BPM / BPM;
          this.BPM = BPM;
          this.BIS = 60.0 / this.BPM; // beat in seconds
          this.TIS = this.BIS / 480.0; // tick in seconds (1 beat = 480 tick)

          var diff = this.lNow * factor;
          this.lOrigin = WX.now - diff;
          this.lNow = diff;
        },

        advance: function () {
          if (this.running) {
            var delta = WX.now - this.prevTimeStamp;
            this.lNow += delta;
            this.prevTimeStamp = WX.now;
          }
        },

        playback: function () {
          this.lOrigin = WX.now - this.lNow;
          this.prevTimeStamp = WX.now;
          this.running = true;
        },

        stop: function () {
          this.running = false;
        },

        rewind: function () {
          this.lOrigin = this.lNow = 0.0;
        },

        getNow: function () {
          return this.lNow;
        },

        getOrigin: function () {
          return this.lOrigin;
        }
      };


      // metronome
      function Metronome (timeline) {

        var tl = timeline;
        this.event = new Event(0, 0);

        this.setBufferMap = function (buffermap) {
          this._bufferMap = buffermap;
          this._buffer = this._bufferMap.getBufferByIndex(0);
        }

        this.setBufferByName = function (name) {
          this._buffer = this._bufferMap.getBufferByName(name);
        }

        this.tick = function () {
          var time = tl.getOrigin() + tl.getLinearTime(this.event);

          var source = WX.context.createBufferSource();
          var volume = WX.context.createGain();
          source.connect(volume);
          volume.connect(uMetroFader._inlet);

          source.buffer = this._buffer;
          volume.gain.setValueAtTime(0.75, time);
          source.start(time);
          source.stop(time + source.buffer.duration);

          this.event.move(1, 0);
        }

        this.reset = function () {
          this.event.set(0, 0);
        }
      }





      // timing stuff
      var divClock = document.getElementById('i-clock');

      var uMetroFader = WX.Fader();
      uMetroFader.to(WX.DAC);

      var timeline = new Timeline(120);
      var metro = new Metronome(timeline);



      var gLookAhead = 0.020; // 20ms
      function playMetronome () {
        //console.log(timeline.getLinearTime(metro.event), timeline.getNow() + gLookAhead);
        if (timeline.getLinearTime(metro.event) < timeline.getNow() + gLookAhead) {
          metro.tick();
        }
      }

      //var gLookAhead = gQuantum * 2; // 1 quantums
      // function lookAheadAndSchedule () {
      //   var t = gOrigin + gNextEvent.getLinearTime();
      //   if (t < WX.now + gLookAhead) {
      //     ticker.tick(t);
      //     gNextEvent = new Event(++gCurrentBeat, 0);
      //   }
      // }

      var bPlayback = false;
      function run () {
        timeline.advance();
        playMetronome();
        var now = timeline.getMusicalTime(timeline.getNow());
        divClock.textContent = now.beat + ':' + ('000' + now.tick).slice(-3);
        if (bPlayback) {
          requestAnimationFrame(run);
        }
      }
      //run();





      // ------------------------------------------------------
      // UI
      var sec_control = UI.ControlCenter.createSection("Control", "i-container");
      var btn_playback = UI.ControlCenter.createControl({
        type: "button", name: "Play", value: false, mode: "toggle"
      }, sec_control);
      var btn_rewind = UI.ControlCenter.createControl({
        type: "button", name: "Rewind", value: false, mode: "oneshot"
      }, sec_control);
      var sli_tempo = UI.ControlCenter.createControl({
        type: "slider", name: "Tempo", value: timeline.BPM, min: 30.0, max: 240.0,
        precision: 2, scale: "linear", unit: "bpm"
      }, sec_control);

      btn_playback.addAction(function (value) {
        if (value) {
          bPlayback = true;
          run();
          timeline.playback();
        } else {
          bPlayback = false;
          timeline.stop();
        }
      });

      btn_rewind.addAction(function (value) {
        timeline.rewind();
        metro.reset();
      });

      sli_tempo.addAction(function (value) {
        timeline.setBPM(value);
      });





      // --------------------------------------------------------
      // build buffermap
      WX.buildBufferMap(
        {
          payload: {
            "Sample 1": "../data/PADS-10/mpc2000/P_SN_RIM.wav"
            // "Sample 2": "../data/PADS-10/tr909/909rim.wav",
            // "Sample 3": "../data/PADS-10/cr78/Rim Shot.wav",
            // "Sample 4": "../data/PADS-10/cr78/Bongo High.wav",
            // "Sample 5": "../data/PADS-10/cr78/Bongo Low.wav",
            // "Sample 6": "../data/PADS-10/asrx/ASR-X Hat 02.wav"
          }
        },
        function (buffermap) {
          metro.setBufferMap(buffermap);
          console.log("done.");
        },
        function (progress) {
          console.log("loading...");
        }
      );

      // ----------------------------------------------------------
      // MIDI routing
      var gTestTarget = Ktrl.createTarget("test");
      gTestTarget.onData(function (midimessage) {
        var data = Ktrl.parse(midimessage);
        switch (data.type) {
        }
      });

      Ktrl.ready(function () {
        Ktrl.routeAllToTarget(gTestTarget);
        gTestTarget.activate();
      });

    </script>
  </body>
</html>