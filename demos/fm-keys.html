<!DOCTYPE html>
<html>
  <head>
    <link href="static/demos.css" rel="stylesheet" type="text/css">
  </head>
  <body>

    <div class="c-demohome"><a href="index.html">Index</a></div>
    <h1>FM Keys</h1>

    <div class="c-body-wrapper" id="i-container">
      <h2>Audio Signal Flow</h2>
      <ul class="c-signalflow">
        <li>Fmop (Dynamic)</li> <li class="separator"></li>
        <li>ADSR (Dynamic)</li> <li class="separator"></li>
        <li>Chorus</li> <li class="separator"></li>
        <li>Pingpong</li> <li class="separator"></li>
        <li>Converb</li> <li class="separator"></li>
        <li>DAC</li>
      </ul>
      <h2>MIDI Signal Flow</h2>
      <ul class="c-signalflow">
        <li>MIDI</li> <li class="separator"></li>
        <li>Fmop</li> <li class="separator"></li>
        <li>ADSR</li>
      </ul>
      <h2>MIDI Control Map</h2>
      <ul class="c-controlmap">
        <li>
          <dt>Modulation (CC7)</dt><dd>Brightness</dd>
          <dt>Modulation (CC10)</dt><dd>Octave</dd>
          <dt>Modulation (CC74)</dt><dd>Envelope Sustain</dd>
          <dt>Modulation (CC71)</dt><dd>Envelope Release</dd>
          <dt>Modulation (CC73)</dt><dd>Chorus Mix</dd>
          <dt>Modulation (CC72)</dt><dd>Delay Mix</dd>
          <dt>Modulation (CC91)</dt><dd>Delay Time</dd>
          <dt>Modulation (CC92)</dt><dd>Reverb mix</dd>
        </li>
      </ul>
    </div>

    <!-- lib r8 -->   
    <script src="../src/core/WAAX.js"></script>
    <script src="../src/core/Utils.js"></script>
    <script src="../src/core/Builtin.js"></script>
    <script src="../src/core/Unit.js"></script>
    <script src="../src/generator/Oscil.js"></script>
    <script src="../src/generator/Fmop.js"></script>
    <script src="../src/generator/Noise.js"></script>
    <script src="../src/generator/ITrain.js"></script>
    <script src="../src/generator/Sampler.js"></script>
    <script src="../src/generator/Step.js"></script>
    <script src="../src/processor/Fader.js"></script>
    <script src="../src/processor/Spatter.js"></script>
    <script src="../src/processor/ADSR.js"></script>
    <script src="../src/processor/Filter.js"></script>
    <script src="../src/processor/Filterbank.js"></script>
    <script src="../src/processor/Formant.js"></script>
    <script src="../src/processor/FormantV.js"></script>
    <script src="../src/processor/Pingpong.js"></script>
    <script src="../src/processor/Chorus.js"></script>
    <script src="../src/processor/Phasor.js"></script>
    <script src="../src/processor/Comp.js"></script>
    <script src="../src/processor/Converb.js"></script>
    <script src="../src/analyzer/Waveform.js"></script>
    <script src="../src/analyzer/Spectrum.js"></script>
    <script src="../src/core/Boot.js"></script>
    <!-- Ktrl -->
    <script src="../lib/Ktrl/Ktrl.js"></script>
    
    <script>
      
      // master out
      var chor = WX.Chorus({ mix:0.1 });
      var pong = WX.Pingpong({ 
          mix:0.1, delayTimeLeft: 0.160, delayTimeRight: 0.480,
          feedbackLeft: 0.5, feedbackRight: 0.25 });
      var verb = WX.Converb({ mix: 0.4, source:"../data/PADS-10/ir/960-LargePlate.wav" });
      chor.to(pong).to(verb).to(WX.DAC);
      
      // fm vars
      var HR = 2;
      var MI1 = 8;
      var BAL = 0.5;
      var SUS = 0.4;
      var REL = 1.0;
      
      function Voice (pitch, velo) {
        // dynamic node creation
        var fund = WX.pitch2freq(pitch);
        this._fm1 = WX.Fmop({ freq:fund, gain:1 - BAL, modIndex:0.1 });
        this._fm2 = WX.Fmop({ freq:fund * 2, gain:BAL, modIndex:0.5 });
        this._env = WX.ADSR();
        this._env.adsr(0.001, 0.07, SUS, REL);

        // connection
        this._fm1.to(this._env).to(chor);
        this._fm2.to(this._env);

        this.noteon(velo);
      }

      Voice.prototype = {
        noteon: function (velo) {
          this._fm1.start(time);
          this._fm2.start(time);
          this._fm1.harmRatio(HR).modIndex(MI1).modIndex(0.1, WX.now+1.5, "x");
          this._fm2.harmRatio(HR).modIndex(MI1 * 0.5).modIndex(0.5, WX.now+1.5, "x");
          this._env.gain(velo).noteOn();
        },
        noteoff: function () {
          this._fm1.stop(WX.now+REL+0.25);
          this._fm2.stop(WX.now+REL+0.25);
          this._env.noteOff();
        }
      }
      
      var _voices = [];

      // key input handler
      window.addEventListener("keydown", function(e) {
        var kc = e.keyCode;
        if (kc < 48 || kc > 57) {
          return;
        }
        onset(WX.pitch2freq(kc - 1));
      });

      // creates a MIDI target
      var t = Ktrl.createTarget("mySynth");
      // activate!
      t.activate();

      // define user-action for incoming MIDI message
      t.onData(function (midimessage) {
        // parse MIDI data with the utility
        var data = Ktrl.parse(midimessage);
        //console.log(t.label, data);
        switch (data.type) {
          case "noteon":
            if (_voices[data.pitch]) {
              return;
            } else {
              MI1 = Ktrl.scale(Ktrl.CurveSquared(data.velocity), 1, 10); 
              _voices[data.pitch] = new Voice(data.pitch, Ktrl.scale(Ktrl.CurveLinear(data.velocity), 0, 1.5));
            }
            break;
          case "noteoff":
            if (_voices[data.pitch]) {
              _voices[data.pitch].noteoff();
              _voices[data.pitch] = null;  
            }
            break;
          case "controlchange":
            switch (data.control) {
              case 7:
                HR = ~~Ktrl.scale(Ktrl.CurveLinear(data.value), 1, 6);
                break;
              case 10:
                BAL = Ktrl.scale(Ktrl.CurveLinear(data.value));
                break;
              case 74:
                SUS = Ktrl.scale(Ktrl.CurveLinear(data.value), 0.01, 0.5);
                break;
              case 71:
                REL = Ktrl.scale(Ktrl.CurveLinear(data.value), 0.01, 2.0);
                break;
              case 73:
                chor.mix(Ktrl.scale(Ktrl.CurveLinear(data.value), 0.3, 0.7), WX.now+0.05);
                break;
              case 72:
                pong.mix(Ktrl.scale(Ktrl.CurveLinear(data.value), 0, 0.5), WX.now+0.05);
                break;
              case 91:
                DEL = Ktrl.scale(Ktrl.CurveLinear(data.value), 0.160, 0.480);
                pong.delayTimeRight(DEL, WX.now+0.1, "l");
                pong.delayTimeLeft(DEL * 3, WX.now+0.1, "l");
                break;
              case 92:
                verb.mix(Ktrl.scale(Ktrl.CurveLinear(data.value)), WX.now+0.05);
                //WX.DAC.gain(Ktrl.scale(Ktrl.CurveLinear(data.value), 0, 1), WX.now+0.1, "l");
                break;
              
            }
            break;
        }
      });

      // routes sources and targets when the system is ready
      Ktrl.ready(function () {
        Ktrl.report();
        Ktrl.routeAllToTarget(t);
      });
    </script>
  </body>
</html>