<!DOCTYPE html>
<html>
 <head>
  <link href="../lib/UI/UI-light.css" rel="stylesheet" type="text/css">
  <link href="static/PADS-10.css" rel="stylesheet" type="text/css">
 </head>
 <body>

  <!-- html -->
  <div class="container">
    <h1>PADS-10</h1>
    <div id="s-preset"></div>
    <div id="s-pad" class="c-pad"></div>
    <div class="clearfix"></div>
    <div id="s-control"></div>
    <div id="s-master"></div>
  </div>

  <!-- lib r8 -->
  <script src="../src/core/WAAX.js"></script>
  <script src="../src/core/Utils.js"></script>
  <script src="../src/core/Builtin.js"></script>
  <script src="../src/core/Unit.js"></script>
  <script src="../src/generator/Oscil.js"></script>
  <script src="../src/generator/Fmop.js"></script>
  <script src="../src/generator/Noise.js"></script>
  <script src="../src/generator/ITrain.js"></script>
  <script src="../src/generator/Sampler.js"></script>
  <script src="../src/generator/Step.js"></script>
  <script src="../src/processor/Fader.js"></script>
  <script src="../src/processor/Spatter.js"></script>
  <script src="../src/processor/ADSR.js"></script>
  <script src="../src/processor/AHR.js"></script>
  <script src="../src/processor/Filter.js"></script>
  <script src="../src/processor/Formant.js"></script>
  <script src="../src/processor/FormantV.js"></script>
  <script src="../src/processor/Pingpong.js"></script>
  <script src="../src/processor/Chorus.js"></script>
  <script src="../src/processor/Phasor.js"></script>
  <script src="../src/processor/Dist.js"></script>
  <script src="../src/processor/Comp.js"></script>
  <script src="../src/processor/Converb.js"></script>
  <script src="../src/processor/Multiverb.js"></script>
  <script src="../src/analyzer/Waveform.js"></script>
  <script src="../src/analyzer/Spectrum.js"></script>
  <script src="../src/core/Boot.js"></script>
  <script src="../lib/Ktrl/Ktrl.js"></script>
  <script src="../lib/UI/UI.js"></script>
  <script src="../lib/UI/UISlider.js"></script>
  <script src="../lib/UI/UIButton.js"></script>
  <script src="../lib/UI/UIIndexedList.js"></script>

  <!-- Pad10 logic -->
  <script src="presets/PADS-10-assets.js"></script>
  <script src="presets/PADS-10-presets.js"></script>
  <script src="static/PADS-10.js"></script>

  <!-- test code -->
  <script>

    // drumkit & impulse response list
    var gDrumKitList = [];
    var gIRList = [];
    for (var kit in DrumKits) {
      gDrumKitList.push(kit);
    }
    for (var ir in ImpulseResponses.Default.payload) {
      gIRList.push(ir);
    }

    // preset list
    var gPresetList = [];
    for (var i = 0; i < Presets.length; i++) {
      gPresetList.push(Presets[i].name);
    }

    /**
     * UI
     */
    // global
    var s_preset = UI.ControlCenter.createSection("Presets", "s-preset");
    var list_preset = UI.ControlCenter.createControl({
      type: "indexed-list", name: "Preset", value: "",
      data: ["Not yet..."],
      exclude: true
    }, s_preset);
    var list_drumkit = UI.ControlCenter.createControl({
      type: "indexed-list", name: "Drum Kit", value: "",
      data: gDrumKitList,
      exclude: true
    }, s_preset);
    var btn_savePreset = UI.ControlCenter.createControl({
      type: "button", name: "Save", value: false, mode: "oneshot",
      exclude: true
    }, s_preset);
    var btn_importPreset = UI.ControlCenter.createControl({
      type: "button", name: "Import", value: false, mode: "oneshot",
      exclude: true
    }, s_preset);
    var btn_exportPreset = UI.ControlCenter.createControl({
      type: "button", name: "Export", value: false, mode: "oneshot",
      exclude: true
    }, s_preset);

    // section: cell control
    var s_cellControl = UI.ControlCenter.createSection("Cell Setting", "s-control");

    // pad control : sample
    var ss_sample = UI.ControlCenter.createSubSection("Sample", s_cellControl);
    var btn_mute = UI.ControlCenter.createControl({
      type: "button", name: "Mute", value: false, mode: "toggle"
     }, ss_sample);
    var list_samples = UI.ControlCenter.createControl({
      type: "indexed-list", name: "Sample", value: "",
      data: ["loading..."]
    }, ss_sample);
    var sli_tune = UI.ControlCenter.createControl({
      type: "slider", name: "Tune", value: 0.0, min: -1200.0, max: 1200.0,
      precision: 0, scale: "linear", unit: "cents"
     }, ss_sample);
    var sli_volume = UI.ControlCenter.createControl({
      type: "slider", name: "Volume", value: 0.0, min: -80.0, max: 12.0,
      precision: 2, scale: "linear", unit: "dB"
     }, ss_sample);

    // pad control : envelope
    var ss_envelope = UI.ControlCenter.createSubSection("Envelope", s_cellControl);
    var btn_env = UI.ControlCenter.createControl({
      type: "button", name: "Envelope", value: false, mode: "toggle"
     }, ss_envelope);
    var sli_att = UI.ControlCenter.createControl({
      type: "slider", name: "Attack", value: 0.0, min: 0.0, max: 1.0,
      precision: 4, scale: "linear", unit: "s"
     }, ss_envelope);
    var sli_hld = UI.ControlCenter.createControl({
      type: "slider", name: "Hold", value: 0.05, min: 0.0, max: 1.0,
      precision: 4, scale: "linear", unit: "s"
     }, ss_envelope);
    var sli_rel = UI.ControlCenter.createControl({
      type: "slider", name: "Release", value: 1.0, min: 0.0, max: 5.0,
      precision: 4, scale: "linear", unit: "s"
     }, ss_envelope);

    // pad control : 2 shelving filter
    var ss_filter = UI.ControlCenter.createSubSection("Filter", s_cellControl);
    var btn_filt = UI.ControlCenter.createControl({
      type: "button", name: "Filters", value: false, mode: "toggle"
     }, ss_filter);
    var sli_freq = UI.ControlCenter.createControl({
      type: "slider", name: "Frequency", value: 2500, min: 60.0, max: 7000.0,
      precision: 2, scale: "log", unit: "Hz"
     }, ss_filter);
    var sli_loshelf = UI.ControlCenter.createControl({
      type: "slider", name: "Low Shelf", value: 0.0, min: -12.0, max: 12.0,
      precision: 2, scale: "linear", unit: "dB"
     }, ss_filter);
    var sli_hishelf = UI.ControlCenter.createControl({
      type: "slider", name: "High Shelf", value: 0.0, min: -12.0, max: 12.0,
      precision: 2, scale: "linear", unit: "dB"
     }, ss_filter);


    // master
    var s_master = UI.ControlCenter.createSection("Master Effects", "s-master");

    // master : comp
    var ss_comp = UI.ControlCenter.createSubSection("Compressor", s_master);
    var btn_comp = UI.ControlCenter.createControl({
      type: "button", name: "Comp", value: false, mode: "toggle"
     }, ss_comp);
    var sli_thre = UI.ControlCenter.createControl({
      type: "slider", name: "Threshold", value: -12.0, min: -60.0, max: 0.0,
      precision: 2, scale: "linear", unit: "dB"
     }, ss_comp);
    var sli_rat = UI.ControlCenter.createControl({
      type: "slider", name: "Ratio", value: 8.0, min: 0.0, max: 20.0,
      precision: 2, scale: "linear", unit: ""
     }, ss_comp);
    var sli_makeup = UI.ControlCenter.createControl({
      type: "slider", name: "Makeup", value: 4.0, min: -12.0, max: 12.0,
      precision: 2, scale: "linear", unit: "dB"
     }, ss_comp);

    // master : sat + verb + master gain
    var ss_final = UI.ControlCenter.createSubSection("", s_master);
    var btn_crush = UI.ControlCenter.createControl({
      type: "button", name: "Crush", value: false, mode: "toggle"
     }, ss_final);
    var sli_crush = UI.ControlCenter.createControl({
      type: "slider", name: "Crush Drive", value: 0.0, min: 0.0, max: 36.0,
      precision: 2, scale: "linear", unit: "dB"
     }, ss_final);
    var sli_vrbmix = UI.ControlCenter.createControl({
      type: "slider", name: "Reverb Mix", value: 0.0, min: 0.0, max: 1.0,
      precision: 2, scale: "linear", unit: ""
     }, ss_final);
    var list_irs = UI.ControlCenter.createControl({
      type: "indexed-list", name: "Reverb Presets", value: "",
      data: gIRList,
    }, ss_final);
    // var sli_mastergain = UI.ControlCenter.createControl({
    //   type: "slider", name: "Master Gain", value: 0.0, min: -60.0, max: 12.0,
    //   precision: 2, scale: "linear", unit: "dB"
    //  }, ss_final);

    /**
     * actions
     */
    // btn_exportPreset.addAction(function () {
    // var presets = UI.ControlCenter.exportPresets();
    // console.log(presets);
    // });


    // shorcut: update cell setting
    function updateCellSettingView() {
      var c = Pad10.cell.getParams();
      btn_mute.setValue(c.muted);
      sli_tune.setValue(c.tune);
      sli_volume.setValue(c.volume);
      list_samples.setListData(c.sampleNames);
      list_samples.setValue(c.sampleName);
      btn_env.setValue(c.envState);
      sli_att.setValue(c.attack);
      sli_hld.setValue(c.hold);
      sli_rel.setValue(c.release);
      btn_filt.setValue(c.filterState);
      sli_freq.setValue(c.filterFreq);
      sli_loshelf.setValue(c.LSGain);
      sli_hishelf.setValue(c.HSGain);
    }

    // shorcut: update cell setting
    function updateMasterEffectView() {
      var m = Pad10.getMasterParams();
      //console.log(m);
      btn_comp.setValue(m.comp.active);
      sli_thre.setValue(m.comp.threshold);
      sli_rat.setValue(m.comp.ratio);
      sli_makeup.setValue(m.comp.makeup);
      btn_crush.setValue(m.crush.active);
      sli_crush.setValue(m.crush.drive);
      sli_vrbmix.setValue(m.reverb.mix);
      //list_irs.setValue(m.reverb.preset);
    }

    // start loading initial drum kit
    Pad10.loadDrumKit(DrumKits.MPC2000, updateCellSettingView);

    // onReady!!
    Pad10.onReady(function () {

      console.log("Ready! Starting...");

      // the order is very important... should be fixed
      list_samples.setListData(Pad10.cell.getSampleNames());
      list_samples.setValue(Pad10.cell.getSampleName());

      // Control Panel
      list_preset.addAction(function(value) {
        // find preset name in presets
        // for(var i = 0; i < Presets.length; i++) {
        //   if (Presets[i].name === value) {
        //     Pad10.loadPreset(Presets[i]);
        //     break;
        //   }
        // }
      });
      list_drumkit.addAction(function (value) {
        Pad10.loadDrumKit(DrumKits[value], updateCellSettingView);
      });
      btn_savePreset.addAction(function () {
        var name = window.prompt("Save preset as...");
        console.log(Pad10.savePreset(name));
      });

      // sample: add actions
      btn_mute.addAction(function (value) {
        Pad10.cell.setSampleMute(value);
      });
      sli_tune.addAction(function (value) {
        Pad10.cell.setSampleTune(value);
      });
      sli_volume.addAction(function (value) {
        Pad10.cell.setSampleVolume(value);
      });
      list_samples.addAction(function (value) {
        Pad10.cell.setBufferByName(value);
      });

      // envelope: add actions
      btn_env.addAction(function (value) {
        Pad10.cell.setEnvelopeState(value);
      });
      sli_att.addAction(function (value) {
        Pad10.cell.setAttack(value);
      });
      sli_hld.addAction(function (value) {
        Pad10.cell.setHold(value);
      });
      sli_rel.addAction(function (value) {
        Pad10.cell.setRelease(value);
      });

      // filter: add actions
      btn_filt.addAction(function (value) {
        Pad10.cell.setFilterState(value);
      });
      sli_freq.addAction(function (value) {
        Pad10.cell.setFilterFreq(value);
      });
      sli_loshelf.addAction(function (value) {
        Pad10.cell.setLSGain(value);
      });
      sli_hishelf.addAction(function (value) {
        Pad10.cell.setHSGain(value);
      });

      // master section
      btn_comp.addAction(function (value) {
        Pad10.comp.active(value);
      });
      sli_thre.addAction(function (value) {
        Pad10.comp.threshold(value);
      });
      sli_rat.addAction(function (value) {
        Pad10.comp.ratio(value);
      });
      sli_makeup.addAction(function (value) {
        Pad10.comp.makeup(value);
      });
      btn_crush.addAction(function (value) {
        Pad10.dist.active(value);
      });
      sli_crush.addAction(function (value) {
        var amp = WX.db2lin(value);
        Pad10.dist.drive(amp);
        Pad10.dist.gain(1/amp);
      });
      sli_vrbmix.addAction(function (value) {
        Pad10.verb.mix(value);
      });
      list_irs.addAction(function (value) {
        Pad10.verb.setBufferByName(value);
      });
      // sli_mastergain.addAction(function (value) {
      //   WX.DAC.db(value);
      // });

    });

    // onCellChanged
    Pad10.onCellChanged(function () {
      updateCellSettingView();
    });

    // onPresetChanged
    Pad10.onPresetChanged(function () {
      //updateDrumKitView();
      //updateMasterEffectView();
      //updateCellSettingView();
    });

    // MIDI
    var gMIDITarget = Ktrl.createTarget("PADS-10");
    Ktrl.ready(function () {
      Ktrl.routeAllToTarget(gMIDITarget);
      gMIDITarget.activate();
    });

    gMIDITarget.onData(function (midimessage) {
      var data = Ktrl.parse(midimessage);
      switch (data.type) {
        case "noteon":
          Pad10.handleMIDINote(data);
          break;
        case "controlchange":
          UI.ControlCenter.handleMIDILearn(data);
          break;
      }
    });

  </script>
 </body>
</html>