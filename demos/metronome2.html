<!DOCTYPE html>
<html>
  <head>
    <link href="static/demos.css" rel="stylesheet" type="text/css">
    <link href="../lib/UI/UI-light.css" rel="stylesheet" type="text/css">
    <style>
      .c-clock {
        background-color: #333;
        width: 400px;
        height: 100px;
        border-radius: 10px;
        color: #3f3;
        font-size: 50px;
        font-family: monospace;
        line-height: 100px;
        text-align: center;
      }
    </style>
  </head>
  <body>

    <div class="c-demohome"><a href="index.html">Index</a></div>
    <h1>Metronome (Refac)</h1>
    <div class="c-body-wrapper" id="i-container">
      <div class="c-clock" id="i-clock">000:000</div>
    </div>

    <!-- lib r8 -->
    <script src="../src/core/WAAX.js"></script>
    <script src="../src/core/Utils.js"></script>
    <script src="../src/core/Builtin.js"></script>
    <script src="../src/core/Unit.js"></script>
    <script src="../src/generator/Oscil.js"></script>
    <script src="../src/generator/Fmop.js"></script>
    <script src="../src/generator/Noise.js"></script>
    <script src="../src/generator/ITrain.js"></script>
    <script src="../src/generator/Sampler.js"></script>
    <script src="../src/generator/Step.js"></script>
    <script src="../src/processor/Fader.js"></script>
    <script src="../src/processor/Spatter.js"></script>
    <script src="../src/processor/ADSR.js"></script>
    <script src="../src/processor/Filter.js"></script>
    <script src="../src/processor/Filterbank.js"></script>
    <script src="../src/processor/Formant.js"></script>
    <script src="../src/processor/FormantV.js"></script>
    <script src="../src/processor/Pingpong.js"></script>
    <script src="../src/processor/Chorus.js"></script>
    <script src="../src/processor/Phasor.js"></script>
    <script src="../src/processor/Comp.js"></script>
    <script src="../src/processor/Converb.js"></script>
    <script src="../src/analyzer/Waveform.js"></script>
    <script src="../src/analyzer/Spectrum.js"></script>
    <script src="../src/core/Boot.js"></script>
    <!-- Ktrl -->
    <script src="../lib/Ktrl/Ktrl.js"></script>
    <script src="../lib/UI/UI.js"></script>
    <script src="../lib/UI/UISlider.js"></script>
    <script src="../lib/UI/UIButton.js"></script>
    <script src="../lib/UI/UIIndexedList.js"></script>
    <!-- sequencer -->
    <script src="static/Sequencer.js"></script>
    <!-- scripts -->
    <script>

      // greater timeline
      var TL = new WX.Timeline(120);

      // clock display
      var divClock = document.getElementById('i-clock');
      function _updateClock() {
        var now = TL.getMusicalNow();
        divClock.textContent = now.beat + ':' + ('000' + now.tick).slice(-3);
      }

      // runner
      function gPlay() {

        TL.advance();

        _updateClock();

        if (TL.isRunning()) {
          requestAnimationFrame(gPlay);
        }
      }


      // ------------------------------------------------------
      // UI
      var sec_control = UI.ControlCenter.createSection("Control", "i-container");
      var btn_playback = UI.ControlCenter.createControl({
        type: "button", name: "Play", value: false, mode: "toggle"
      }, sec_control);
      var btn_rewind = UI.ControlCenter.createControl({
        type: "button", name: "Rewind", value: false, mode: "oneshot"
      }, sec_control);
      var sli_tempo = UI.ControlCenter.createControl({
        type: "slider", name: "Tempo", value: TL.BPM, min: 30.0, max: 240.0,
        precision: 2, scale: "linear", unit: "bpm"
      }, sec_control);

      btn_playback.addAction(function (value) {
        if (value) {
          TL.start();
          gPlay();
        } else {
          TL.stop();
        }
      });

      btn_rewind.addAction(function (value) {
        TL.rewind();
        _updateClock();
      });

      sli_tempo.addAction(function (value) {
        TL.setBPM(value);
      });





      // --------------------------------------------------------
      // build buffermap
      WX.buildBufferMap(
        {
          payload: {
            "Sample 1": "../data/PADS-10/mpc2000/P_SN_RIM.wav"
          }
        },
        function (buffermap) {
          TL.setMetronomeBuffer(buffermap.getBufferByIndex(0));
          console.log("buffer loaded.");
        },
        function (progress) {
          console.log("loading...");
        }
      );

      // ----------------------------------------------------------
      // MIDI routing
      // var gTestTarget = Ktrl.createTarget("test");
      // gTestTarget.onData(function (midimessage) {
      //   var data = Ktrl.parse(midimessage);
      //   switch (data.type) {
      //   }
      // });

      Ktrl.ready(function () {
        // Ktrl.routeAllToTarget(gTestTarget);
        // gTestTarget.activate();
      });

    </script>
  </body>
</html>