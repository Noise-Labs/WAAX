<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <h1>Noise Drone</h1>
    <p>requires Canary Web MIDI build...</p>
    <script src="../build/waax.min.js"></script>
    <script>
var v = WX.Converb({ mix: 0.1 });
        var f = WX.Filter({ cutoff: 7000, Q:1.5 });
        f.to(WX.DAC);
        
        function Stream (opt) {
          // ugens
          this.n = WX.Noise({ gain: 0.75 });
          this.f1 = WX.Filter({ 
            type: "bandpass", 
            cutoff: opt.freq * 0.9999, 
            Q: opt.Q,
            gain: opt.gain
          });
          this.f2 = WX.Filter({ 
            type: "bandpass", 
            cutoff: opt.freq * 1.0001, 
            Q: opt.Q,
            gain: opt.gain
          });
          this.s = WX.Spatter();
          this.n.to(this.f1).to(this.f2).to(this.s).to(f);
          // params
          this.speed = opt.speed;
          this.cartPos = {};
          this.polarPos = { 
            x: 1.0,
            y: Math.PI * 2 * Math.random(),
            z: Math.PI * 2 * Math.random()
          };
          this.convert();
          this.n.gain(0.0).gain(2.0, 2.0, "l");
        }

        Stream.prototype.convert = function() {
          var p = this.polarPos;
          this.cartPos.x = p.x * Math.sin(p.y) * Math.cos(p.z);
          this.cartPos.y = p.x * Math.cos(p.y);
          this.cartPos.z = p.x * Math.sin(p.y) * Math.sin(p.z);
        }

        Stream.prototype.move = function() {
          this.polarPos.z += this.speed;
          if (this.polarPos.z > Math.PI) {
            this.polarPos.z = Math.PI;
            this.speed *= -1;
          } else if (this.polarPos.z < 0.0) {
            this.polarPos.z = 0.0;
            this.speed *= -1;
          }
          this.polarPos.y += this.speed;
          this.convert();
          this.s.panner(this.cartPos);
        }

        Stream.prototype.freq = function(f) {
          this.f1.cutoff(f * 0.9999);
          this.f2.cutoff(f * 1.0001);
        }

        var s = [];
        var maxStream = 36;
        var curve = 1.2;
        var fund = 120;
        var rFactor = 2; 
        var rat = fund / rFactor;
        for (var i = 0; i < maxStream; ++i) {
          s[i] = new Stream({ 
            freq: fund + rat * Math.pow(2, i),
            Q: 36 + 48 * 1 / Math.pow(1.1, i), 
            gain: 1 / Math.pow(1.2, i),
            speed: (Math.random() - 0.5) * 0.25
          });
          // console.log(1 / Math.pow(1.2, i));
        }

        function rotate() {
          for (var i = 0; i < maxStream; ++i) {
            s[i].move();
          }
          setTimeout(rotate, 200);
        }
        rotate();

        function changeFund(f) {
          fund = f;
          rat = fund / Math.pow(2, rFactor);
          for (var i = 0; i < maxStream; ++i) {
            s[i].f1.cutoff(fund + rat * Math.pow(2, i) * 0.9999, WX.now+0.05, "x");
            s[i].f2.cutoff(fund + rat * Math.pow(2, i) * 1.0001, WX.now+0.05, "x");
          }
        }

        function changeRat(r) {
          rFactor = r;
          rat = fund / Math.pow(2, rFactor);
          for (var i = 0; i < maxStream; ++i) {
            s[i].f1.cutoff(fund + rat * Math.pow(2, i) * 0.9999, WX.now+0.02, "x");
            s[i].f2.cutoff(fund + rat * Math.pow(2, i) * 1.0001, WX.now+0.02, "x");
          }
        }

        function changeGain(f) {
          for (var i = 0; i < maxStream; ++i) {
            s[i].f1.gain(1 / Math.pow(f, i), WX.now+0.02, "l");
            s[i].f2.gain(1 / Math.pow(f, i), WX.now+0.02, "l");
          }
        }

        function changeQ(q) {
          for (var i = 0; i < maxStream; ++i) {
            s[i].f1.Q(36 + 48 * 1 / Math.pow(q, i), WX.now+0.02, "l");
            s[i].f2.Q(36 + 48 * 1 / Math.pow(q, i), WX.now+0.02, "l");
          }
        }


     var midi = null;  // global MIDIAccess object

function onMIDISuccess( midiAccess ) {
  console.log( "MIDI ready!" );
  midi = midiAccess;  // store in the global (in real usage, would probably keep in an object instance)
  console.dir(midi);
  //listInputsAndOutputs(midi);
  startLoggingMIDIInput(midi, 1);
}

function onMIDIFailure(msg) {
  console.log( "Failed to get MIDI access - " + msg );
}

navigator.requestMIDIAccess().then( onMIDISuccess, onMIDIFailure );

function listInputsAndOutputs( midiAccess ) {
  var inputs = midiAccess.inputs();
  var outputs = midiAccess.outputs();
  var i;

  for (i=0; i<inputs.length; i++) {
    console.log( "Input port #" + i + 
      ": type:'" + inputs[i].type +
      "' id:'" + inputs[i].id +
      "' manufacturer:'" + inputs[i].manufacturer +
      "' name:'" + inputs[i].name +
      "' version:'" + inputs[i].version + "'" );
  }

  for (i=0; i<outputs.length; i++) {
    console.log( "Output port #" + i + 
      ": type:'" + outputs[i].type +
      "' id:'" + outputs[i].id +
      "' manufacturer:'" + outputs[i].manufacturer +
      "' name:'" + outputs[i].name +
      "' version:'" + outputs[i].version + "'" );
  }
}

var pitches = [60, 90, 120, 150];

function onMIDIMessage( event ) {
  var str = "MIDI message received at timestamp " + event.timestamp + "[" + event.data.length + " bytes]: ";
  var d = event.data;
  if (d.length === 3) {
    var b1 = d[0].toString(16);
    var b2 = d[1].toString(16);
    var b3 = d[2];
    if (b1 === "99") {
      switch(b2) {
        case "30":
          //changeFund(pitches[0]);
          changeRat(1);
        break;
        case "34":
          //changeFund(pitches[1]);
          changeRat(3);
        break;
        case "36":
          //changeFund(pitches[2]);
          changeRat(6);
        break;
        case "3a":
          //changeFund(pitches[3]);
          changeRat(8);
        break;
      }
    } else {
      switch(b2) {
        case "30":
        break;
        case "3a":
        break;
      }
    }
  }
  if (b1 === "b9") {
    switch(b2) {
      case "14":
        var p = b3 / 127;
        changeQ(p + 0.5);
        break;
      case "15":
        var p = b3 / 127 * 0.5;
        changeGain(1.5 - p);
        break;
    }
  }
  for (var i=0; i<event.data.length; i++) {  
    var key = event.data[i].toString(16);
    str += "0x" + key + " ";
  }

  console.log( str );
}

function startLoggingMIDIInput( midiAccess, indexOfPort ) {
  var input = midiAccess.inputs()[indexOfPort];
  console.dir(input);
  input.onmidimessage = onMIDIMessage;
}

    </script>
  </body>
</html>