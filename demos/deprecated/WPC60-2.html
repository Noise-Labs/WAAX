<!DOCTYPE html>
<html>
  <head>
    <link href="../lib/Ktrl/UI-r2.css" rel="stylesheet" type="text/css">
    <link href="style/WPC60.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    
    <!-- lib r8 -->   
    <script src="../src/core/WAAX.js"></script>
    <script src="../src/core/Utils.js"></script>
    <script src="../src/core/Builtin.js"></script>
    <script src="../src/core/Unit.js"></script>
    <script src="../src/generator/Oscil.js"></script>
    <script src="../src/generator/Fmop.js"></script>
    <script src="../src/generator/Noise.js"></script>
    <script src="../src/generator/ITrain.js"></script>
    <script src="../src/generator/Sampler.js"></script>
    <script src="../src/generator/Step.js"></script>
    <script src="../src/processor/Fader.js"></script>
    <script src="../src/processor/Spatter.js"></script>
    <script src="../src/processor/ADSR.js"></script>
    <script src="../src/processor/AHR.js"></script>
    <script src="../src/processor/Filter.js"></script>
    <script src="../src/processor/Formant.js"></script>
    <script src="../src/processor/FormantV.js"></script>
    <script src="../src/processor/Pingpong.js"></script>
    <script src="../src/processor/Chorus.js"></script>
    <script src="../src/processor/Phasor.js"></script>
    <script src="../src/processor/Comp.js"></script>
    <script src="../src/processor/Converb.js"></script>
    <script src="../src/analyzer/Waveform.js"></script>
    <script src="../src/analyzer/Spectrum.js"></script>
    <script src="../src/core/Boot.js"></script>
    <script src="../lib/Ktrl/Ktrl.js"></script>
    <script src="../lib/Ktrl/UI-r2.js"></script>
    
    <!-- test code -->
    <script>

    function DrummerPad (path, filenames) {

      this._currentBufferIndex = 0;
      this._buffers = [];
      this._path = path;
      this._filenames = filenames;

      this._attack = 0.005;
      this._hold = 0.010;
      this._release = 0.75;
      this._tune = 0.0;

      this._output = WX.context.createGain();

      this.loadAssets();
    }

    DrummerPad.prototype = {

      to: function (unit) {
        this._output.connect(unit._inlet);
        return unit;
      },

      loadAssets: function () {
        // quite hacky.. need some elegant solution
        for (var i = 0; i < this._filenames.length; i++) {
          if (i === this._filenames.length - 1) {
            WX._loadBuffers(this._path + this._filenames[i], this._buffers, i, this.onloaded.bind(this));
          } else {
            WX._loadBuffers(this._path + this._filenames[i], this._buffers, i);
          }
        }
      },

      noteOn: function (intensity, moment) {
        var source = WX.context.createBufferSource();
        var env = WX.context.createGain();
        source.connect(env);
        env.connect(this._output);

        source.buffer = this._buffers[this._currentBufferIndex];
        moment = (moment || WX.now);
        var prate = Math.pow(2, this._tune / 1200);
        source.playbackRate.setValueAtTime(prate, moment);

        source.start(moment);
        env.gain.setValueAtTime(0.0, moment);
        env.gain.linearRampToValueAtTime(intensity, moment + this._attack);
        env.gain.setValueAtTime(intensity, moment + this._attack + this._hold);
        env.gain.exponentialRampToValueAtTime(0.0, moment + this._attack + this._hold + this._release);
        source.stop(moment + this._attack + this._hold + this._release);
      },

      setCurrentBuffer: function (index) {
        this._currentBufferIndex = index;
        return this.getCurrentFilename();
      },

      changeBufferByIndexDelta: function (delta) {
        this._currentBufferIndex = WX.clamp(
          this._currentBufferIndex + delta, 
          0, 
          this._buffers.length - 1
        );
        return this.getCurrentFilename();
      },

      getCurrentFilename: function () {
        return this._filenames[this._currentBufferIndex];
      },

      setTune: function (value) {
        this._tune = value;
      },

      setAttack: function (value) {
        this._attack = value;
      },

      setHold: function (value) {
        this._hold = value;
      },

      setRelease: function (value) {
        this._release = value;
      },

      getParameters: function () {
        return {
          tune: this._tune,
          attack: this._attack,
          hold: this._hold,
          release: this._release
        };
      },

      onloaded: function () {
        this._currentBufferIndex = 0;
        this.getCurrentFilename();
        WX._log.post("DrummerPad loaded. (current: " + this.getCurrentFilename() + ")");
        filename.textContent = "Loaded.";
      },
    }

    var pathSD = "../data/wpc/sd/";
    var filenamesSD = [ 
      "sd1.wav", "sd2.wav", "sd3.wav", "sd4.wav", "sd5.wav",
      "sd6.wav", "sd7.wav", "sd8.wav", "sd9.wav", "sd10.wav"
    ];
    var pathKD = "../data/wpc/kd/";
    var filenamesKD = [ 
      "kd1.wav", "kd2.wav", "kd3.wav", "kd4.wav", "kd5.wav",
      "kd6.wav", "kd7.wav", "kd8.wav", "kd9.wav", "kd10.wav"
    ];


    var sdPad = new DrummerPad(pathSD, filenamesSD);
    var kdPad = new DrummerPad(pathKD, filenamesKD);

    
    // static elements (channel)
    sdPad.to(WX.DAC);
    kdPad.to(WX.DAC);

    var pads = [];
    pads.push(sdPad);
    pads.push(kdPad);
    var currentPad = 0;

    var section = document.getElementById('section');

    var options1 = { container: section, precision: 0.5 };
    var options2 = { container: section, precision: 4 };

    // get values from pad0
    var prms = pads[currentPad].getParameters();
      
    var pitCon = new UI.SliderController("Tune", "cents", prms.tune, -1200, 1200, options1);
    var attCon = new UI.SliderController("Attack", "s", prms.attack, 0.001, 0.100, options2);
    var hldCon = new UI.SliderController("Hold", "s", prms.hold, 0.001, 0.500, options2);
    var relCon = new UI.SliderController("Release", "s", prms.release, 0.001, 2.0, options2);
    
    pitCon.onchange = function (value) {
      pads[currentPad].setTune(value);
    }
    attCon.onchange = function (value) {
      pads[currentPad].setAttack(value);
    }
    hldCon.onchange = function (value) {
      pads[currentPad].setHold(value);
    }
    relCon.onchange = function (value) {
      pads[currentPad].setRelease(value);
    }

    function updateAllViews () {
      var prms = pads[currentPad].getParameters();
      pitCon.setValue(prms.tune);
      attCon.setValue(prms.attack);
      hldCon.setValue(prms.hold);
      relCon.setValue(prms.release);
    }
    
    var title = document.getElementById('title');    
    var prev = document.getElementById('prev');
    var next = document.getElementById('next');
    var filename = document.getElementById('filename');
    prev.addEventListener('mousedown', function () {
      filename.textContent = pads[currentPad].changeBufferByIndexDelta(-1);
    });
    next.addEventListener('mousedown', function () {
      filename.textContent = pads[currentPad].changeBufferByIndexDelta(1);
    });

    var btnPad1 = document.getElementById('pad-1');
    var btnPad2 = document.getElementById('pad-2');
    btnPad1.onmousedown = function () {
      currentPad = 0;
      title.textContent = "Snare Drum";
      updateAllViews();
    };
    btnPad2.onmousedown = function () {
      currentPad = 1;
      title.textContent = "Kick Drum";
      updateAllViews();
    };
    currentPad = 0;
    title.textContent = "Snare Drum";

    var targetWPC60 = Ktrl.createTarget("WPC60");
    targetWPC60.onData(function (midimessage) {
      var data = Ktrl.parse(midimessage);
      // console.log(targetWPC60.label, data);
      switch (data.type) {
        case "noteon":
          switch (data.pitch) {
            case 48: case 52:
              kdPad.noteOn(Ktrl.CurveCubed(data.velocity), WX.now);
              break;
            case 54: case 58:
              sdPad.noteOn(Ktrl.CurveCubed(data.velocity), WX.now);
              break;
          }
          break;
      }
    });

    Ktrl.ready(function () {
      Ktrl.routeAllToTarget(targetWPC60);
      targetWPC60.activate();
    });
     
    
    
    </script>
  </body>
</html>