<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <canvas id="canvas-wx-waveform" style="width:600px; height:200px; position:absolute; bottom:5px; right:5px;"></canvas>
    <script src="../build/WAAX.min.js"></script>
    <script>
      // creating units
      var osc1 = new WX.Oscil({ type:2, gain:0.4 }),
          osc2 = new WX.Oscil({ type:1, gain:0.4 }),
          adsr = new WX.ADSR({ a: 0.005, d: 0.03, s: 0.2, r: 0.1 }),
          rezz = new WX.LPRez({ a: 0.05, d: 0.015, s: 0.5, r: 0.05, range:4000, Q:9 }),
          pong = new WX.TwinDelay({ 
            delayTimeLeft:0.360, delayTimeRight:0.240, 
            feedbackLeft:0.4, feedbackRight:0.25,
            crosstalk: 0.2, mix:0.2 }),
          verb = new WX.ConVerb({ mix:0.2 }),
          comp = new WX.Comp({ threshold: -24, ratio: 8, gain: 2 }),
          wf = new WX.Waveform();
      
      // build an audiograph
      WX.link(osc1, rezz, adsr, pong, verb, comp, WX.DAC);
      osc2.to(rezz);
      comp.to(wf);
      // set master level
      WX.DAC.db = -12;
      
      // variables
      var gridDur = 0.240, glideTime = 0.180, playhead = 0;
      // scores for pitches, accent, slide
      var pit = [3, 0, 5, 0, 3, 2, 1, 0, 0, 0, 8, 0, 6, 0, 7, 0];
      var acc = [1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0];
      var sli = [0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 1];
      
      // looper
      function loop() {
        // NOTE: DO NOT DO THIS for serious production.
        // use Web Audio API scheduling technique instead.
        setTimeout(function() {
          // get pitch
          var f = WX.pitch2freq(pit[playhead] + 48);
          // glide or not?
          if(sli[playhead] == 0) {
            osc1.frequency = f;
            osc2.frequency = f * 0.5;
          } else {
            osc1.glide(f, glideTime);
            osc2.glide(f * 0.5, glideTime);
          }
          // get rez filter working
          rezz.cutoff = f * 1.5;
          if(sli[playhead] == 0) {
            rezz.noteOn();
          } else {
            rezz.noteOff(gridDur);
          }
          // trigger a note
          adsr.gain = acc[playhead] + 1 * 0.5;
          adsr.noteOn();
          adsr.noteOff(gridDur);          
          // check playhead and wrap it as needed
          playhead = ++playhead > 15 ? 0 : playhead;
          // do this again
          loop();
        }, gridDur * 1000);
      }
      
      // draw waveform
      function draw() {
        setTimeout(function() {
          wf.draw();
          draw();
        }, 1000/30);
      }
      
      // inititate
      loop();
      draw();
    </script>
  </body>
</html>